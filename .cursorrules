# Quant Binance Trading Bot - Project Rules

## 專案概述
這是一個 Binance 量化交易系統，支援現貨 (Spot) 和合約 (Futures) 交易。
包含策略開發、回測、驗證、模擬交易、實盤交易的完整流程。

---

## 開發環境設置

### 虛擬環境
**重要：執行任何 Python 指令前，必須先啟動虛擬環境！**

```bash
# 啟動虛擬環境（每次開新 terminal 都要執行）
cd /Users/dylanting/Documents/spot_bot/quant-binance-spot
source .venv/bin/activate

# 確認環境已啟動（會看到 (.venv) 前綴）
which python  # 應該顯示 .venv/bin/python
```

### 安裝依賴
```bash
pip install -r requirements.txt
pip install -e .  # 安裝專案為 editable 模式
```

### 環境變數（交易用）
```bash
export BINANCE_API_KEY=your_key
export BINANCE_API_SECRET=your_secret
```

---

## 資料流 (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           開發流程                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 數據下載          2. 回測              3. 驗證              4. 實盤   │
│  ┌──────────┐       ┌──────────┐        ┌──────────┐        ┌────────┐ │
│  │Binance   │──────▶│ vectorbt │───────▶│Walk-Fwd  │───────▶│Paper   │ │
│  │API       │       │ backtest │        │Monte-Car │        │Trading │ │
│  └──────────┘       └──────────┘        │PBO/DSR   │        └────────┘ │
│       │                  │              └──────────┘             │      │
│       ▼                  ▼                   │                   ▼      │
│  data/binance/      reports/             reports/           實盤交易    │
│  {spot|futures}/    {strategy}/          validation/                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         模組依賴關係                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         config.py (中心配置)                              │
│                              │                                          │
│              ┌───────────────┼───────────────┐                          │
│              ▼               ▼               ▼                          │
│          strategy/       data/           live/                         │
│              │               │               │                          │
│              └───────┬───────┘               │                          │
│                      ▼                       │                          │
│                 backtest/ ◀──────────────────┘                          │
│                      │                                                  │
│                      ▼                                                  │
│                validation/                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 依賴管理

### 新增 Python 套件
```bash
# 1. 加入 requirements.txt
echo "new-package>=1.0.0" >> requirements.txt

# 2. 安裝
pip install -r requirements.txt
# 或
pip install new-package
```

### 主要依賴
| 套件 | 用途 | 位置 |
|------|------|------|
| `vectorbt` | 回測引擎 | `backtest/` |
| `pandas` | 數據處理 | 全域 |
| `numpy` | 數值計算 | 全域 |
| `ta` | 技術指標 | `indicators/` |
| `httpx` | API 請求 | `data/binance_client.py` |
| `pyyaml` | 配置解析 | `config.py` |
| `python-telegram-bot` | 通知 | `monitor/notifier.py` |

---

## 實際執行指南

### 完整開發流程
```bash
# Step 1: 下載數據
python scripts/download_data.py -c config/futures_rsi_adx_atr.yaml

# Step 2: 回測
python scripts/run_backtest.py -c config/futures_rsi_adx_atr.yaml

# Step 3: 驗證 (確認沒有過擬合)
python scripts/validate.py -c config/futures_rsi_adx_atr.yaml --quick

# Step 4: 參數優化 (可選)
python scripts/optimize_params.py -c config/futures_rsi_adx_atr.yaml

# Step 5: 模擬交易 (至少跑 1-2 週)
python scripts/run_live.py -c config/futures_rsi_adx_atr.yaml --paper

# Step 6: 實盤 (確認模擬穩定後)
python scripts/run_live.py -c config/futures_rsi_adx_atr.yaml
```

### 腳本對應表
| 我想要... | 執行腳本 | 關鍵參數 |
|-----------|----------|----------|
| 下載 K 線 | `download_data.py` | `-c config.yaml` |
| 跑回測 | `run_backtest.py` | `-c`, `--symbol`, `--direction` |
| 驗證策略 | `validate.py` | `--quick`, `--full`, `--only` |
| 優化參數 | `optimize_params.py` | `--symbol`, `--metric` |
| 模擬交易 | `run_live.py` | `--paper` |
| 實盤交易 | `run_live.py` | (無 --paper) |
| 設定 Cron | `setup_cron.sh` | `-c`, `--mode` |

---

## 目錄結構

```
src/qtrade/
├── strategy/          # 策略開發
│   ├── base.py        # StrategyContext, BaseStrategy
│   ├── filters.py     # 信號過濾器 (trend, volume, volatility, HTF)
│   ├── exit_rules.py  # 出場規則 (止損/止盈/移動止損)
│   └── *.py           # 具體策略實作
├── backtest/          # 回測引擎
│   ├── run_backtest.py   # 核心回測邏輯 (vectorbt)
│   ├── metrics.py        # 績效指標計算
│   ├── plotting.py       # 圖表繪製
│   └── kelly_validation.py # Kelly 公式驗證
├── validation/        # 策略驗證
│   ├── walk_forward.py   # Walk-Forward 分析
│   ├── prado_methods.py  # DSR, PBO, CPCV (López de Prado)
│   ├── cross_asset.py    # 跨資產驗證
│   └── consistency.py    # Live/Backtest 一致性
├── live/              # 實盤/模擬交易
│   ├── paper_broker.py      # 模擬交易 Broker
│   ├── binance_spot_broker.py   # 現貨 Broker
│   ├── binance_futures_broker.py # 合約 Broker (待實作)
│   └── runner.py        # LiveRunner 主迴圈
├── data/              # 數據管理
│   ├── binance_client.py # Binance REST API
│   ├── klines.py         # K線獲取
│   └── storage.py        # Parquet 儲存
├── monitor/           # 監控通知
│   └── notifier.py    # Telegram 通知
├── risk/              # 風險管理
│   └── monte_carlo.py # Monte Carlo 模擬
└── config.py          # 配置管理 (dataclass + YAML)

scripts/               # 執行腳本
├── download_data.py   # 下載 K線數據
├── run_backtest.py    # 執行回測
├── run_live.py        # 執行實盤/模擬
├── validate.py        # 策略驗證
└── optimize_params.py # 參數優化

config/                # 配置檔案
├── rsi_adx_atr.yaml          # 現貨策略配置
└── futures_rsi_adx_atr.yaml  # 合約策略配置

data/binance/          # K線數據 (Parquet)
├── spot/1h/           # 現貨數據
└── futures/1h/        # 合約數據

reports/               # 回測報告
├── {strategy}/        # 現貨報告
└── futures/{strategy}/ # 合約報告
```

## 核心概念

### 信號範圍
- **Spot (現貨)**: `[0, 1]` - 只做多
- **Futures (合約)**: `[-1, 1]` - 多空都做
  - `+1.0` = 全倉做多
  - `-1.0` = 全倉做空
  - `0.0` = 空倉

### StrategyContext
策略上下文，提供市場資訊給策略：
```python
ctx = StrategyContext(
    symbol="BTCUSDT",
    interval="1h",
    market_type="futures",  # "spot" | "futures"
    direction="both",       # "both" | "long_only" | "short_only"
)
ctx.supports_short  # True if futures and not long_only
ctx.can_long        # True if not short_only
ctx.can_short       # True if futures and not long_only
```

### vectorbt 注意事項
- 使用 `pf.positions.records_readable` 而非 `pf.trades.records_readable`
- `trades` 會把部分平倉拆成多筆，`positions` 才是完整的 round-trip
- 合約回測使用 `direction="both"`

### 配置結構 (YAML → dataclass)
```yaml
market:
  market_type: futures  # spot | futures
  symbols: [BTCUSDT, ETHUSDT]
  interval: 1h

futures:  # 合約專用
  leverage: 1
  margin_type: cross
  direction: both  # both | long_only | short_only

strategy:
  name: rsi_adx_atr
  params: {...}

notification:  # Telegram
  bot_token: xxx
  chat_id: xxx
  prefix: "[FUTURES]"
```

## 開發規範

### 程式碼風格
- 中文註解，英文變數/函數名
- Type hints 必須
- docstring 用中文說明
- 單一職責：一個函數做一件事

### 可擴展性原則

#### 新增策略
```python
# src/qtrade/strategy/my_strategy.py
from .base import StrategyContext
from . import register_strategy

@register_strategy("my_strategy")  # 1. 註冊名稱
def generate_positions(df: pd.DataFrame, ctx: StrategyContext, params: dict) -> pd.Series:
    """
    我的策略
    
    Args:
        df: K線數據 (OHLCV)
        ctx: 策略上下文 (symbol, interval, market_type, direction)
        params: 策略參數 (從 YAML 讀取)
    
    Returns:
        持倉信號 Series，Spot [0,1]，Futures [-1,1]
    """
    # 2. 計算指標
    # 3. 生成信號
    # 4. 套用 filters (可選)
    # 5. 套用 exit_rules (可選)
    
    if ctx.supports_short:
        return pos.clip(-1.0, 1.0)
    return pos.clip(0.0, 1.0)
```

#### 新增 Broker
```python
# src/qtrade/live/my_broker.py
from .broker_interface import BrokerProtocol

class MyBroker(BrokerProtocol):
    """實作 BrokerProtocol 介面"""
    
    def get_balance(self, asset: str = "USDT") -> float:
        """取得餘額"""
        ...
    
    def get_position(self, symbol: str) -> dict:
        """取得持倉"""
        ...
    
    def place_order(self, symbol: str, side: str, quantity: float, ...) -> dict:
        """下單"""
        ...
```

#### 新增指標
```python
# src/qtrade/indicators/my_indicator.py
import pandas as pd

def calculate_my_indicator(series: pd.Series, period: int = 14) -> pd.Series:
    """
    計算自訂指標
    
    Returns:
        指標值 Series，index 與輸入對齊
    """
    ...

# 在 __init__.py 匯出
# from .my_indicator import calculate_my_indicator
```

#### 新增驗證方法
```python
# src/qtrade/validation/my_validation.py
# 參考 walk_forward.py 或 prado_methods.py 的模式
```

### 可維護性原則

1. **配置與邏輯分離**
   - 所有可調參數放 YAML
   - 程式碼不 hardcode 數值

2. **模組獨立性**
   - `strategy/` 不依賴 `live/`
   - `backtest/` 不依賴 `validation/`
   - 透過 `config.py` 傳遞資訊

3. **錯誤處理**
   - API 呼叫要 try-catch
   - 使用 logging 而非 print
   - 失敗要有 fallback

4. **測試友善**
   - 函數接受參數，不讀全域
   - 可注入 mock 物件

### 命名規範
| 類型 | 規範 | 範例 |
|------|------|------|
| 策略檔案 | `{name}_strategy.py` | `rsi_adx_atr_strategy.py` |
| 配置檔案 | `{name}.yaml` | `futures_rsi_adx_atr.yaml` |
| 指標函數 | `calculate_{name}` | `calculate_rsi()` |
| Broker 類別 | `{Exchange}{Market}Broker` | `BinanceFuturesBroker` |

## 專案資源清單

### 執行腳本 (`scripts/`)

| 腳本 | 用途 | 常用參數 |
|------|------|----------|
| `download_data.py` | 下載 K 線數據 | `-c config.yaml`, `--symbol`, `--full` |
| `run_backtest.py` | 執行回測 | `-c`, `--direction`, `--symbol`, `-t` |
| `validate.py` | 策略驗證 | `-c`, `--quick`, `--full`, `--only` |
| `run_live.py` | 實盤/模擬交易 | `-c`, `--paper`, `--real`, `--status`, `--check` |
| `optimize_params.py` | 參數優化 | `--strategy`, `--metric`, `--symbol` |
| `create_strategy.py` | 建立新策略 | `--name`, `--type` |
| `daily_report.py` | 每日報告 | `-c` |
| `health_check.py` | 健康檢查 | `--notify`, `--json` |
| `setup_cron.sh` | 設置 Cron Jobs | `--install`, `--remove`, `--show` |
| `setup_secrets.py` | 設置 API 密鑰 | (互動式) |

### 測試腳本 (`scripts/`)

| 腳本 | 用途 |
|------|------|
| `test_futures_connection.py` | Futures API 連線測試（不需 API Key） |
| `test_futures_broker.py` | Futures Broker 完整測試 |
| `test_futures_risk.py` | 風控模組測試 |
| `test_futures_manual.py` | 手動測試 |

### 配置檔 (`config/`)

| 檔案 | 用途 |
|------|------|
| `base.yaml` | 基礎配置模板 |
| `rsi_adx_atr.yaml` | RSI+ADX+ATR 現貨策略 |
| `futures_rsi_adx_atr.yaml` | RSI+ADX+ATR 合約策略 |
| `validation.yaml` | 驗證配置 |
| `dev.yaml` | 開發環境配置 |

### 文件 (`docs/`)

| 檔案 | 內容 |
|------|------|
| `CLI_REFERENCE.md` | **CLI 指令集快速參考** ⭐ |
| `QUICK_START_GUIDE.md` | 快速入門指南 |
| `COMMAND_LINE_USAGE.md` | 命令行使用說明 |
| `ARCHITECTURE_PROPOSAL.md` | 架構設計文件 |
| `DATA_QUALITY.md` | 數據品質說明 |
| `RISK_MANAGEMENT.md` | 風險管理說明 |
| `STRATEGY_PORTFOLIO.md` | 策略組合說明 |
| `TRADING_STRATEGIES_REFERENCE.md` | 交易策略參考 |
| `PROJECT_FEATURES.md` | 專案功能說明 |

### 部署相關

#### Cron 設置 (`scripts/setup_cron.sh`)
```bash
# 互動模式
./scripts/setup_cron.sh

# 直接安裝
./scripts/setup_cron.sh --install

# 移除
./scripts/setup_cron.sh --remove

# 查看目前設定
./scripts/setup_cron.sh --show
```

#### Oracle Cloud 部署
```bash
# SSH 進入
ssh user@oracle_ip

# 更新程式碼
cd ~/quant-binance-spot && git pull

# 啟動虛擬環境
source .venv/bin/activate

# 測試
python scripts/run_live.py -c config/futures_rsi_adx_atr.yaml --paper --once

# 設置 cron
./scripts/setup_cron.sh --install
```

---

## 常用指令

```bash
# 下載數據
python scripts/download_data.py -c config/futures_rsi_adx_atr.yaml

# 回測
python scripts/run_backtest.py -c config/futures_rsi_adx_atr.yaml --direction both

# 驗證
python scripts/validate.py -c config/futures_rsi_adx_atr.yaml --quick

# 模擬交易
python scripts/run_live.py -c config/futures_rsi_adx_atr.yaml --paper

# 參數優化
python scripts/optimize_params.py -c config/rsi_adx_atr.yaml --symbol BTCUSDT

# 查看帳戶狀態
python scripts/run_live.py -c config/futures_rsi_adx_atr.yaml --status

# API 連線測試
python scripts/test_futures_connection.py
```

## 待完成功能 (TODO)
- [x] BinanceFuturesBroker 實作（真實合約交易）✅ 已完成
- [x] 合約風控（強平價格計算、資金費率追蹤）✅ 已完成

## 已完成的合約交易功能

### BinanceFuturesHTTP (`src/qtrade/data/binance_futures_client.py`)
- Futures API HTTP 客戶端
- 自動重試和端點切換
- 便利方法: `get_klines`, `get_mark_price`, `get_funding_rate`

### BinanceFuturesBroker (`src/qtrade/live/binance_futures_broker.py`)
- 市價開多/開空: `market_long()`, `market_short()`
- 市價平倉: `market_close()`
- 目標倉位執行: `execute_target_position(target_pct)`
- 槓桿設定: `set_leverage(symbol, leverage)`
- 保證金類型: `set_margin_type(symbol, "ISOLATED"|"CROSSED")`
- 訂單管理: `get_open_orders()`, `cancel_order()`, `cancel_all_orders()`
- 持倉查詢: `get_position()`, `get_positions()`, `get_position_pct()`
- 帳戶查詢: `get_balance()`, `get_equity()`, `get_account_info()`
- 連線檢查: `check_connection()`
- 支援 `dry_run=True` 測試模式

### FuturesRiskManager (`src/qtrade/live/futures_risk.py`)
- 強平價格計算: `calculate_liquidation_price(symbol)`
- 資金費率查詢: `get_funding_rate_info(symbol)`
- 歷史費率: `get_funding_rate_history(symbol, limit)`
- 風險等級檢查: `check_position_risk(symbol)`
- 全持倉風險: `check_all_positions_risk()`
- 風險報告: `generate_risk_report()`, `print_risk_report()`
- 風險閾值: `LIQUIDATION_WARNING_PCT`, `MARGIN_RATIO_WARNING`, `FUNDING_RATE_HIGH`
