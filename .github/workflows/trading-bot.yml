# ============================================================
# GitHub Actions â€” æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œäº¤æ˜“ç­–ç•¥
# ============================================================
#
# åŸç†ï¼š
#   1. æ¯å°æ—¶ç¬¬ 5 åˆ†é’Ÿè§¦å‘ï¼ˆç­‰ K çº¿æ”¶ç›˜ + æ•°æ®å…¥åº“ï¼‰
#   2. æ‹‰å–æœ€æ–°ä»£ç  â†’ å®‰è£…ä¾èµ– â†’ è¿è¡Œ run_live.py --once
#   3. Paper Trading æ¨¡å¼ä¼šæŠŠçŠ¶æ€æ–‡ä»¶ commit å› repoï¼ˆæ–­çº¿æ¢å¤ï¼‰
#
# è®¾ç½®æ­¥éª¤ï¼ˆåªéœ€åšä¸€æ¬¡ï¼‰ï¼š
#   1. æŠŠé¡¹ç›® push åˆ° GitHub
#   2. åˆ° GitHub Repo â†’ Settings â†’ Secrets and variables â†’ Actions
#   3. æ·»åŠ ä»¥ä¸‹ Secretsï¼š
#      - TELEGRAM_BOT_TOKEN  ï¼ˆTelegram é€šçŸ¥ç”¨ï¼‰
#      - TELEGRAM_CHAT_ID    ï¼ˆTelegram é€šçŸ¥ç”¨ï¼‰
#   4. âœ… å®Œæˆï¼æ¯å°æ—¶ä¼šè‡ªåŠ¨è¿è¡Œ
#
# åˆ‡æ¢åˆ°çœŸå®äº¤æ˜“æ—¶ï¼Œé¢å¤–æ·»åŠ ï¼š
#      - BINANCE_API_KEY
#      - BINANCE_API_SECRET
#   å¹¶å°†ä¸‹æ–¹ mode æ”¹ä¸º "real"
#
# å…è´¹é¢åº¦ï¼š
#   - Public repoï¼šæ— é™åˆ†é’Ÿ
#   - Private repoï¼šæ¯æœˆ 2,000 åˆ†é’Ÿï¼ˆæ¯æ¬¡çº¦ 1~2 åˆ†é’Ÿï¼Œä¸€å¤© 24 æ¬¡ â‰ˆ æœˆç”¨ 720 åˆ†é’Ÿï¼‰
# ============================================================

name: Trading Bot

on:
  # â”€â”€ å®šæ—¶è§¦å‘ï¼šæ¯å°æ—¶ç¬¬ 5 åˆ†é’Ÿ â”€â”€
  schedule:
    - cron: '5 * * * *'

  # â”€â”€ æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰â”€â”€
  workflow_dispatch:
    inputs:
      mode:
        description: 'äº¤æ˜“æ¨¡å¼'
        required: true
        default: 'paper'
        type: choice
        options:
          - paper
          - real

# é˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹
concurrency:
  group: trading-bot
  cancel-in-progress: false

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€ 1. æ‹‰å–ä»£ç  â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ push æƒé™ï¼ˆç”¨äºä¿å­˜ paper trading çŠ¶æ€ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 2. è®¾ç½® Python â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # â”€â”€ 3. å®‰è£…ä¾èµ– â”€â”€
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .

      # â”€â”€ 4. è¿è¡Œç­–ç•¥ï¼ˆä¸€æ¬¡æ€§ï¼‰ â”€â”€
      - name: Run trading strategy
        env:
          # GitHub Actions åœ¨ç¾å›½ï¼Œapi.binance.com ä¼šå°é”ç¾å›½ IP (HTTP 451)
          # ä½¿ç”¨ data-api.binance.vision ä½œä¸ºå…¬å¼€æ•°æ®ç«¯ç‚¹ï¼Œä¸å—åœ°åŒºé™åˆ¶
          BINANCE_BASE_URL: "https://data-api.binance.vision"
          # Telegram é€šçŸ¥ï¼ˆå¯é€‰ï¼Œä¸è®¾ä¹Ÿèƒ½è·‘ï¼‰
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # Binance APIï¼ˆçœŸå®äº¤æ˜“æ‰éœ€è¦ï¼‰
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
        run: |
          echo "ğŸ• $(date -u '+%Y-%m-%d %H:%M UTC') â€” å¼€å§‹è¿è¡Œç­–ç•¥"
          python scripts/run_live.py \
            --config config/rsi_adx_atr.yaml \
            --paper \
            --once
          echo "âœ… ç­–ç•¥æ‰§è¡Œå®Œæˆ"

      # â”€â”€ 5. ä¿å­˜ Paper Trading çŠ¶æ€ â”€â”€
      # æ¯æ¬¡è¿è¡ŒåæŠŠ paper_state.json commit å› repo
      # è¿™æ ·ä¸‹æ¬¡è¿è¡Œæ—¶å¯ä»¥æ¢å¤æŒä»“çŠ¶æ€
      - name: Save paper trading state
        run: |
          git config user.name "Trading Bot"
          git config user.email "bot@github-actions"

          # åª commit çŠ¶æ€æ–‡ä»¶
          git add reports/live/ || true

          # å¦‚æœæœ‰å˜åŒ–æ‰ commit
          if git diff --staged --quiet; then
            echo "ğŸ“ çŠ¶æ€æ— å˜åŒ–ï¼Œè·³è¿‡ commit"
          else
            git commit -m "ğŸ¤– Paper Trading state update $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "ğŸ’¾ çŠ¶æ€å·²ä¿å­˜"
          fi

