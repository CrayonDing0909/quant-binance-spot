---
alwaysApply: true
---
# Project Overview â€” quant-binance-spot

Binance Spot/Futures quantitative trading system. Python 3.11, vectorbt-based backtesting.

## Environment

- **Activate venv first**: `source .venv/bin/activate` (Python 3.11 symlink)
- **Run scripts**: `PYTHONPATH=src python scripts/<script>.py -c config/<config>.yaml`
- **Run tests**: `python -m pytest tests/ -x -q --tb=short`
- **Install packages**: `python3.11 -m pip install <pkg>` (ensures correct site-packages)

## Production Strategy

- **Active**: HTF Filter v2 + LSR â€” Meta-Blend 8-Symbol + HTF Filter + LSR Confirmatory Overlay, 3x leverage
  - **Config**: [prod_candidate_htf_lsr.yaml](mdc:config/prod_candidate_htf_lsr.yaml)
  - **Strategy code**: [meta_blend_strategy.py](mdc:src/qtrade/strategy/meta_blend_strategy.py) + [tsmom_carry_v2_strategy.py](mdc:src/qtrade/strategy/tsmom_carry_v2_strategy.py) + [lsr_confirmatory_overlay.py](mdc:src/qtrade/strategy/overlays/lsr_confirmatory_overlay.py)
  - **Deployment**: Oracle Cloud (x86_64, 1GB RAM), WebSocket mode via tmux (`meta_blend_live`)
  - **Routing**: BTC=breakout_vol_atr+tsmom_carry_v2/btc_enhanced+HTF_daily_dominant, ETH/SOL/AVAX/BNB/DOGE/ADA/LINK=tsmom_carry_v2+HTF_C_hard
  - **HTF Filter**: 4h EMA trend + daily ADX regimeï¼ˆå¾ž 1h å› æžœé‡æŽ¡æ¨£ï¼‰
  - **LSR Overlay**: oi_vol+lsr_confirmatoryï¼ˆboost=1.3, reduce=0.3, pctile=0.85ï¼‰
  - **Key metrics**: Portfolio SR=2.87, MDD=-4.75%, Calmar=6.09, 2x Cost SR=2.11
  - **Risk Audit**: APPROVED (2026-02-27), WFA 8/8 OOS+, CPCV PBO 0.07, MC 4/4 PASS
  - **Launched**: 2026-02-27 (replaced HTF Filter v2)
  - **Observation period**: â†’ 2026-03-13, rollback if MDD > -10% or SR < 0 for 3 consecutive days

- **Retired (rollback available)**:
  - **Level 1 â€” HTF Filter v2**: [prod_candidate_htf_filter.yaml](mdc:config/prod_candidate_htf_filter.yaml) (SR=2.75, instant rollback)
  - **Level 2 â€” Meta-Blend baseline**: [prod_candidate_meta_blend.yaml](mdc:config/prod_candidate_meta_blend.yaml) (SR=2.265)
  - **Level 3 â€” R3C Ensemble**: [prod_live_R3C_E3.yaml](mdc:config/prod_live_R3C_E3.yaml) (legacy rollback)

## Approved Candidates (pending paper trading)

- **OI Liquidation Bounce v4.2**: 5-symbol long-only (BTC/ETH/SOL/DOGE/AVAX), 1x leverage
  - **Config**: [prod_live_oi_liq_bounce.yaml](mdc:config/prod_live_oi_liq_bounce.yaml)
  - **Strategy code**: [oi_liq_bounce_strategy.py](mdc:src/qtrade/strategy/oi_liq_bounce_strategy.py)
  - **Status**: ðŸŸ¡ Paper Trading ä¸­ (2026-02-25 èµ·, tmux: `oi_liq_paper`)
  - **Risk conditions applied**: position_pct=0.50, circuit_breaker=10%, 1x leverage
  - **Graduation**: â‰¥ 2026-03-11, OI data stable, no circuit breaker triggers
  - **Key metrics**: Portfolio SR=2.49, MDD=-1.3%, time-in-market=4.2%, correlation w/ R3C â‰ˆ 0.01

## Strategy Portfolio Management

Rules for adding/replacing/retiring strategies in a multi-strategy portfolio:
- **Governance doc**: [STRATEGY_PORTFOLIO_GOVERNANCE.md](mdc:docs/STRATEGY_PORTFOLIO_GOVERNANCE.md)
- **Compare strategies**: `scripts/compare_strategies.py` â€” marginal Sharpe, correlation matrix, optimal weights, redundancy check
- **Multi-strategy backtest**: `scripts/run_portfolio_backtest.py --multi-strategy` â€” combine N independent strategy configs
- **Auto-generate blend config**: `scripts/generate_blend_config.py` â€” produce meta_blend YAML from comparison output

## Directory Map

See [CLI_REFERENCE.md](mdc:docs/CLI_REFERENCE.md) for full project map (auto-generated by `scripts/gen_cli_reference.py`).

```
src/qtrade/
â”œâ”€â”€ config.py           â† AppConfig dataclass, load_config()
â”œâ”€â”€ strategy/           â† Strategy implementations
â”‚   â”œâ”€â”€ base.py         â† StrategyContext (market_type, direction, signal_delay)
â”‚   â”œâ”€â”€ tsmom_strategy.py â† Active production strategy
â”‚   â””â”€â”€ exit_rules.py   â† SL/TP/Adaptive SL
â”œâ”€â”€ backtest/
â”‚   â”œâ”€â”€ run_backtest.py â† BacktestResult dataclass, run_symbol_backtest()
â”‚   â”œâ”€â”€ costs.py        â† Funding Rate + Volume Slippage cost model
â”‚   â””â”€â”€ metrics.py      â† Performance metrics + Long/Short analysis
â”œâ”€â”€ live/
â”‚   â”œâ”€â”€ base_runner.py  â† BaseRunner ABC (14 shared safety mechanisms)
â”‚   â”œâ”€â”€ runner.py       â† LiveRunner (Polling, inherits BaseRunner)
â”‚   â”œâ”€â”€ websocket_runner.py â† WebSocketRunner (Event-driven)
â”‚   â””â”€â”€ signal_generator.py â† SignalResult dataclass
â”œâ”€â”€ validation/         â† WFA, DSR, PBO, CPCV, IC monitor
â”œâ”€â”€ data/               â† Multi-source: Binance/yfinance/ccxt
â”œâ”€â”€ risk/               â† Position sizing, Kelly, Monte Carlo
â””â”€â”€ monitor/            â† Health check, Telegram, notifier

config/                 â† Active configs only (~15)
config/archive/         â† Deprecated / completed research configs
scripts/                â† Active reusable scripts (~30)
scripts/archive/        â† One-off research / migration scripts
docs/                   â† Living docs (~5 files)
docs/archive/           â† Historical / superseded docs
```

## Signal Convention

- **Spot**: `[0, 1]` â€” 0=cash, 1=full long
- **Futures**: `[-1, 1]` â€” -1=full short, 0=flat, 1=full long
- Strategies can output `[-1, 1]` uniformly; negative values are auto-clipped for Spot

## Key Dataclasses

- `AppConfig` ([config.py](mdc:src/qtrade/config.py)) â€” unified YAML config
- `StrategyContext` ([base.py](mdc:src/qtrade/strategy/base.py)) â€” market_type, direction, signal_delay
- `BacktestResult` ([run_backtest.py](mdc:src/qtrade/backtest/run_backtest.py)) â€” standardized backtest output
- `SignalResult` ([signal_generator.py](mdc:src/qtrade/live/signal_generator.py)) â€” type-safe live signal

## Config Pattern

Always use `cfg.to_backtest_dict()` / `cfg.market_type_str` / `cfg.direction` â€” never manually assemble.
Research configs go in `config/research_*.yaml`; NEVER modify production config during research.

## Team â€” 5-Agent Workflow

This project uses 5 specialized agents. Each agent has a clear scope and handoff protocol.

### Agent Roster

| Agent | Definition | Scope |
|-------|------------|-------|
| Alpha Researcher | `.cursor/agents/alpha-researcher.md` | Strategy discovery, on-chain data, Notebook EDA, Strategy Proposal |
| Quant Developer | `.cursor/agents/quant-developer.md` | Strategy implementation, backtest execution, report generation, shared module maintenance, config freeze |
| Quant Researcher | `.cursor/agents/quant-researcher.md` | Full validation pipeline (WFA/CPCV/DSR/Cost Stress/Delay Stress), GO/FAIL verdict |
| Risk Manager | `.cursor/agents/risk-manager.md` | Pre-launch risk audit, weekly/monthly portfolio risk review (monthly lead) |
| DevOps | `.cursor/agents/devops.md` | Oracle Cloud deployment, monitoring, production data management, incident response |

### Workflow & Handoff

```
Alpha Researcher â”€â”€â”€ Strategy Proposal â”€â”€â†’ Quant Developer
                                              â”‚
                                    BacktestResult + Report
                                              â”‚
                                              â–¼
                               Quant Researcher (full validation)
                                  â”‚                  â”‚
                             GO_NEXT            NEED_MORE_WORK / FAIL
                                  â”‚                  â”‚
                                  â–¼                  â–¼
                            Risk Manager        Back to Developer
                              â”‚       â”‚         (or Alpha Researcher)
                         APPROVED  REJECTED
                              â”‚       â”‚
                              â–¼       â–¼
                    Quant Developer  Back to Developer
                    (config freeze)
                              â”‚
                              â–¼
                           DevOps
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Production      â”‚
                    â”‚   (live trading)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    Risk Manager (periodic)
                    Weekly quick + Monthly deep
```

### Handoff Rules

1. **Alpha Researcher â†’ Quant Developer**: Strategy Proposal must be complete (all fields filled). Developer confirms data availability before starting.
2. **Quant Developer â†’ Quant Researcher**: BacktestResult + report (metrics, yearly, `--quick` validation). Must use `config/research_*.yaml`. Developer does NOT run WFA/CPCV/Cost Stress â€” that's Researcher's job.
3. **Quant Researcher â†’ Risk Manager**: Only on `GO_NEXT` verdict. Includes validation report + BacktestResult path.
4. **Risk Manager â†’ Quant Developer**: On `APPROVED`, Developer freezes config (`config/research_*.yaml` â†’ `config/prod_live_*.yaml`).
5. **Quant Developer â†’ DevOps**: Frozen `prod_live_*.yaml` + Risk Audit Report. DevOps does NOT create production configs.
6. **Risk Manager â†’ Quant Developer**: On `REJECTED`, includes specific failures and remediation guidance.
7. **Quant Researcher â†’ Quant Developer**: On `NEED_MORE_WORK`, includes specific gates that failed.
8. **Quant Researcher â†’ Alpha Researcher**: If the hypothesis itself is flawed (not just implementation).