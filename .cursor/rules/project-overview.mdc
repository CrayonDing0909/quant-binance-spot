---
alwaysApply: true
---
# Project Overview — quant-binance-spot

Binance Spot/Futures quantitative trading system. Python 3.11, vectorbt-based backtesting.

## Environment

- **Activate venv first**: `source .venv/bin/activate` (Python 3.11 symlink)
- **Run scripts**: `PYTHONPATH=src python scripts/<script>.py -c config/<config>.yaml`
- **Run tests**: `python -m pytest tests/ -x -q --tb=short`
- **Install packages**: `python3.11 -m pip install <pkg>` (ensures correct site-packages)

## Production Strategy

- **Active**: HTF Filter v2 + LSR — Meta-Blend 8-Symbol + HTF Filter + LSR Confirmatory Overlay, 3x leverage
  - **Config**: [prod_candidate_htf_lsr.yaml](mdc:config/prod_candidate_htf_lsr.yaml)
  - **Strategy code**: [meta_blend_strategy.py](mdc:src/qtrade/strategy/meta_blend_strategy.py) + [tsmom_carry_v2_strategy.py](mdc:src/qtrade/strategy/tsmom_carry_v2_strategy.py) + [lsr_confirmatory_overlay.py](mdc:src/qtrade/strategy/overlays/lsr_confirmatory_overlay.py)
  - **Deployment**: Oracle Cloud (x86_64, 1GB RAM), WebSocket mode via tmux (`meta_blend_live`)
  - **Routing**: BTC=breakout_vol_atr+tsmom_carry_v2/btc_enhanced+HTF_daily_dominant, ETH/SOL/AVAX/BNB/DOGE/ADA/LINK=tsmom_carry_v2+HTF_C_hard
  - **HTF Filter**: 4h EMA trend + daily ADX regime（從 1h 因果重採樣）
  - **LSR Overlay**: oi_vol+lsr_confirmatory D mode（boost=1.3, reduce=0.3, pctile=0.85, oi_confirm+fr_confirm）
  - **Key metrics**: Portfolio SR=4.31, MDD=-3.73%, Calmar=11.54, 2x Cost SR=3.32
  - **Risk Audit**: APPROVED (2026-02-27), WFA 8/8 OOS+, CPCV PBO max 0.13, MC 4/4 PASS
  - **Bug fix (2026-02-27)**: overlay_params cross-contamination — 修正後指標大幅提升
  - **Launched**: 2026-02-27 (replaced HTF Filter v2)
  - **Observation period**: → 2026-03-13, rollback if MDD > -10% or SR < 0 for 3 consecutive days

- **Retired (rollback available)**:
  - **Level 1 — HTF Filter v2**: [prod_candidate_htf_filter.yaml](mdc:config/prod_candidate_htf_filter.yaml) (SR=2.75, instant rollback)
  - **Level 2 — Meta-Blend baseline**: [prod_candidate_meta_blend.yaml](mdc:config/prod_candidate_meta_blend.yaml) (SR=2.265)
  - **Level 3 — R3C Ensemble**: [prod_live_R3C_E3.yaml](mdc:config/prod_live_R3C_E3.yaml) (legacy rollback)

## Shelved Strategies (code preserved, not deployed)

- **OI Liquidation Bounce v4.2**: 5-symbol long-only, 1x leverage — **SHELVED (2026-02-27)**
  - **Reason**: Time-in-market=4.2% (每幣種每月 ~0.8 次交易)，資源效益過低
  - **Pivot**: OI 清算反彈 insight 將整合為主策略的 overlay（類似 LSR overlay）
  - **Config**: [prod_live_oi_liq_bounce.yaml](mdc:config/prod_live_oi_liq_bounce.yaml) (preserved)
  - **Strategy code**: [oi_liq_bounce_strategy.py](mdc:src/qtrade/strategy/oi_liq_bounce_strategy.py) (preserved)
  - **Key metrics**: Portfolio SR=2.49, MDD=-1.3%, correlation w/ main ≈ 0.01

## Strategy Portfolio Management

Rules for adding/replacing/retiring strategies in a multi-strategy portfolio:
- **Governance doc**: [STRATEGY_PORTFOLIO_GOVERNANCE.md](mdc:docs/STRATEGY_PORTFOLIO_GOVERNANCE.md)
- **Compare strategies**: `scripts/compare_strategies.py` — marginal Sharpe, correlation matrix, optimal weights, redundancy check
- **Multi-strategy backtest**: `scripts/run_portfolio_backtest.py --multi-strategy` — combine N independent strategy configs
- **Auto-generate blend config**: `scripts/generate_blend_config.py` — produce meta_blend YAML from comparison output

## Directory Map

See [CLI_REFERENCE.md](mdc:docs/CLI_REFERENCE.md) for full project map (auto-generated by `scripts/gen_cli_reference.py`).

```
src/qtrade/
├── config.py           ← AppConfig dataclass, load_config()
├── strategy/           ← Strategy implementations
│   ├── base.py         ← StrategyContext (market_type, direction, signal_delay)
│   ├── tsmom_strategy.py ← Active production strategy
│   └── exit_rules.py   ← SL/TP/Adaptive SL
├── backtest/
│   ├── run_backtest.py ← BacktestResult dataclass, run_symbol_backtest()
│   ├── costs.py        ← Funding Rate + Volume Slippage cost model
│   └── metrics.py      ← Performance metrics + Long/Short analysis
├── live/
│   ├── base_runner.py  ← BaseRunner ABC (14 shared safety mechanisms)
│   ├── runner.py       ← LiveRunner (Polling, inherits BaseRunner)
│   ├── websocket_runner.py ← WebSocketRunner (Event-driven)
│   └── signal_generator.py ← SignalResult dataclass
├── validation/         ← WFA, DSR, PBO, CPCV, IC monitor
├── data/               ← Multi-source: Binance/yfinance/ccxt
├── risk/               ← Position sizing, Kelly, Monte Carlo
└── monitor/            ← Health check, Telegram, notifier

config/                 ← Active configs only (~15)
config/archive/         ← Deprecated / completed research configs
scripts/                ← Active reusable scripts (~30)
scripts/archive/        ← One-off research / migration scripts
docs/                   ← Living docs (~5 files)
docs/archive/           ← Historical / superseded docs
```

## Signal Convention

- **Spot**: `[0, 1]` — 0=cash, 1=full long
- **Futures**: `[-1, 1]` — -1=full short, 0=flat, 1=full long
- Strategies can output `[-1, 1]` uniformly; negative values are auto-clipped for Spot

## Key Dataclasses

- `AppConfig` ([config.py](mdc:src/qtrade/config.py)) — unified YAML config
- `StrategyContext` ([base.py](mdc:src/qtrade/strategy/base.py)) — market_type, direction, signal_delay
- `BacktestResult` ([run_backtest.py](mdc:src/qtrade/backtest/run_backtest.py)) — standardized backtest output
- `SignalResult` ([signal_generator.py](mdc:src/qtrade/live/signal_generator.py)) — type-safe live signal

## Config Pattern

Always use `cfg.to_backtest_dict()` / `cfg.market_type_str` / `cfg.direction` — never manually assemble.
Research configs go in `config/research_*.yaml`; NEVER modify production config during research.

## Team — 5-Agent Workflow

This project uses 5 specialized agents. Each agent has a clear scope and handoff protocol.

### Agent Roster

| Agent | Definition | Scope |
|-------|------------|-------|
| Alpha Researcher | `.cursor/agents/alpha-researcher.md` | Strategy discovery, on-chain data, Notebook EDA, Strategy Proposal |
| Quant Developer | `.cursor/agents/quant-developer.md` | Strategy implementation, backtest execution, report generation, shared module maintenance, config freeze |
| Quant Researcher | `.cursor/agents/quant-researcher.md` | Full validation pipeline (WFA/CPCV/DSR/Cost Stress/Delay Stress), GO/FAIL verdict |
| Risk Manager | `.cursor/agents/risk-manager.md` | Pre-launch risk audit, weekly/monthly portfolio risk review (monthly lead) |
| DevOps | `.cursor/agents/devops.md` | Oracle Cloud deployment, monitoring, production data management, incident response |

### Workflow & Handoff

```
Alpha Researcher ─── Strategy Proposal ──→ Quant Developer
                                              │
                                    BacktestResult + Report
                                              │
                                              ▼
                               Quant Researcher (full validation)
                                  │                  │
                             GO_NEXT            NEED_MORE_WORK / FAIL
                                  │                  │
                                  ▼                  ▼
                            Risk Manager        Back to Developer
                              │       │         (or Alpha Researcher)
                         APPROVED  REJECTED
                              │       │
                              ▼       ▼
                    Quant Developer  Back to Developer
                    (config freeze)
                              │
                              ▼
                           DevOps
                              │
                    ┌─────────┴─────────┐
                    │   Production      │
                    │   (live trading)  │
                    └─────────┬─────────┘
                              │
                    Risk Manager (periodic)
                    Weekly quick + Monthly deep
```

### Handoff Rules

1. **Alpha Researcher → Quant Developer**: Strategy Proposal must be complete (all fields filled). Developer confirms data availability before starting.
2. **Quant Developer → Quant Researcher**: BacktestResult + report (metrics, yearly, `--quick` validation). Must use `config/research_*.yaml`. Developer does NOT run WFA/CPCV/Cost Stress — that's Researcher's job.
3. **Quant Researcher → Risk Manager**: Only on `GO_NEXT` verdict. Includes validation report + BacktestResult path.
4. **Risk Manager → Quant Developer**: On `APPROVED`, Developer freezes config (`config/research_*.yaml` → `config/prod_live_*.yaml`).
5. **Quant Developer → DevOps**: Frozen `prod_live_*.yaml` + Risk Audit Report. DevOps does NOT create production configs.
6. **Risk Manager → Quant Developer**: On `REJECTED`, includes specific failures and remediation guidance.
7. **Quant Researcher → Quant Developer**: On `NEED_MORE_WORK`, includes specific gates that failed.
8. **Quant Researcher → Alpha Researcher**: If the hypothesis itself is flawed (not just implementation).