---
alwaysApply: true
---
# Anti-Bias Rules — CRITICAL

These rules exist because we lost months to look-ahead bias in the RSI strategy.
Every agent MUST internalize these before writing or reviewing any strategy/backtest code.

## 1. Look-Ahead Bias Prevention

- **Signal-Execution Timing**: Signal generated at `close[i]` MUST be executed at `open[i+1]`, NEVER at `open[i]`.
- **signal_delay mechanism**: `StrategyContext.signal_delay = 1` when `trade_on = "next_open"`. This shifts the position series by 1 bar via `.shift(signal_delay)`.
- **Backtest price**: Always use `price=df['open']` in `vbt.Portfolio.from_orders()`. Using `close` introduces look-ahead.
- **Validation**: Every new strategy MUST pass the 5-item look-ahead audit before promotion.

## 2. vectorbt direction Trap

When using `vbt.Portfolio.from_orders(direction="shortonly")`:
- `size > 0` means "open short", `size < 0` means "close short" (INVERTED from intuition)
- Our strategies use `pos=-1` for short, `pos=1` for long

**Required conversion for short_only mode**:
```python
elif direction == "short_only":
    pos = (-pos).clip(lower=0.0)  # -1 → 1 (open short), 1 → clip → 0
```

Always use the shared `to_vbt_direction()` and `clip_positions_by_direction()` functions — never inline this logic.

## 3. Anti-Cherry-Picking (from Playbook Stage D/E)

- No cherry-picking winning windows for reporting
- No post-hoc strategy deletion without pre-defined selection rule
- No mixed timestamps in comparison tables (single run timestamp only)
- No hidden defaults: all active knobs must be explicit in config
- When multiple components exist, run ablation: A only, B only, A+B

## 4. Backtest Integrity Checklist

- `price=df['open']` (not close)
- Cost model enabled: `funding_rate.enabled: true` + `slippage_model.enabled: true`
- Exit rules (ATR SL/TP) direction-aware:
  - Long: SL = price - ATR * multiplier, TP = price + ATR * multiplier
  - Short: SL = price + ATR * multiplier, TP = price - ATR * multiplier
- `_apply_position_sizing` clip range is `[-1, 1]` (not `[0, 1]`)
- Spot negative signal clip happens in `runner.run_once()`, NOT in position_sizing

## 5. HTF Resample + Reindex: 必須 shift(1)

**這是最常見的 look-ahead 陷阱**。歷史上已造成至少 3 次 false-positive 回測。

### 根因

`_resample_ohlcv(df, "4h")` 使用 `label='left'`：4h bar [00:00, 04:00) 的 close 在 03:59 才可用，但 label 標記在 00:00。
直接 `.reindex(target_index, method="ffill")` → 00:00 就用到 03:59 的 close → **提前 3 小時**。

### 唯一正確方式

使用 `causal_resample_align()`（在 `qtrade.strategy.filters` 中）：

```python
from qtrade.strategy.filters import causal_resample_align

trend_1h = causal_resample_align(df, "4h", compute_fn, df.index)
```

此函數內部做了：
1. `_resample_ohlcv(df, freq)` — 重採樣
2. `compute_fn(htf_df)` — 計算指標
3. `result.shift(1)` — **延遲 1 個 HTF bar**
4. `result.reindex(target_index, method="ffill")` — 映射回低級 TF

### 禁止模式（CI 自動偵測）

```python
# ❌ 禁止：resample 後直接 reindex
htf_trend = _htf_trend(df_4h, ...)
trend_1h = htf_trend.reindex(df.index, method="ffill")  # LOOK-AHEAD!

# ✅ 正確：使用 causal_resample_align
trend_1h = causal_resample_align(df, "4h", _htf_trend, df.index)

# ✅ 正確：手動 shift(1)
htf_trend = _htf_trend(df_4h, ...)
htf_trend = htf_trend.shift(1)  # 等 bar 收盤後才用
trend_1h = htf_trend.reindex(df.index, method="ffill")
```

### 例外（白名單）

外部資料對齊（FR、OI、LSR 等）的 `reindex(ffill)` 是安全的：
資料點有獨立的結算/發佈時間戳，不涉及 intra-bar 問題。

`test_resample_shift_guard.py` 自動掃描所有 `.py` 檔，
違反時 CI 會失敗。白名單在測試檔中維護。

## 6. Data Quality Gate

Before any signal uses a dataset:
- Coverage threshold >= 70% (target >= 90%)
- Time alignment documented (timezone, bar alignment)
- Missing value policy documented (max forward-fill gap)

If coverage gate fails, result MUST be marked `INVALID`.

See [STRATEGY_DEV_PLAYBOOK_R2_1.md](mdc:docs/STRATEGY_DEV_PLAYBOOK_R2_1.md) for full validation stack.
