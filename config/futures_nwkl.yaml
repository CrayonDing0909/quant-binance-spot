# åˆç´„ç­–ç•¥é…ç½®ï¼šNW Envelope + Regime Filter + MTF Gating V3
#
# ç­–ç•¥ï¼šNadaraya-Watson Envelope + ADX Regime + 4h MTF + Trend Pullback
#
# V3 ä¿®å¾©ï¼ˆMTF look-ahead audit å¾Œé‡å»ºï¼‰ï¼š
#   1. MTF å°é½Šæ”¹ç‚º right_ffillï¼ˆcausal, 0h é¡å¤–å»¶é²ï¼‰
#   2. æ–°å¢ Phase B entry quality filters:
#      - LTF proxy (EMA 20/50 cross) â†’ 1h å³æ™‚æ–¹å‘ç¢ºèª
#      - Momentum confirmation (3h lookback) â†’ é¿å… catching falling knives
#      - Pullback depth filter (0.3) â†’ åªåœ¨å¤ æ·±çš„å›è¸©å…¥å ´
#      - Re-entry lockout â†’ å‡ºå ´å¾Œéœ€å›ç©¿ NW æ‰é‡å…¥
#   3. æ‰€æœ‰ anti-lookahead æ¸¬è©¦ PASSï¼ˆonline/offline, truncation, boundary, causalityï¼‰
#
# Causal å›æ¸¬çµæœï¼ˆ2022-01 â†’ 2026-02, å…¨æ¨£æœ¬, å« fee+slippage+fundingï¼‰ï¼š
#   BTC: -1.2%, SR=-0.06, MDD=7.0%,  412 trades, WR 51.7%
#   ETH: -1.1%, SR=-0.07, MDD=6.1%,  315 trades, WR 60.3%
#   SOL: +13.2%, SR=+0.79, MDD=4.9%, 578 trades, WR 62.6%
#
# çµè«–ï¼šSOL æœ‰çœŸå¯¦ causal alpha, BTC/ETH capital preservation, MaxDD å¯æ§
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   python scripts/download_data.py -c config/futures_nwkl.yaml
#   python scripts/run_backtest.py -c config/futures_nwkl.yaml
#   python scripts/run_backtest.py -c config/futures_nwkl.yaml --symbol BTCUSDT
#   python scripts/run_portfolio_backtest.py -c config/futures_nwkl.yaml
#   python scripts/run_walk_forward.py -c config/futures_nwkl.yaml --splits 5
#   python scripts/run_live.py -c config/futures_nwkl.yaml --paper

market:
  symbols: ["ETHUSDT", "BTCUSDT", "SOLUSDT"]
  interval: "1h"
  start: "2022-01-01"
  end: null
  market_type: "futures"

futures:
  leverage: 3
  margin_type: "ISOLATED"
  position_mode: "ONE_WAY"
  direction: "both"

strategy:
  name: "nw_envelope_regime"
  params:
    # â•â•â• Ablation Control â•â•â•
    use_mtf: true                  # 4h MTF regime gatingï¼ˆæ ¸å¿ƒï¼ï¼‰
    mtf_alignment_mode: "right_ffill"   # ç„¡å MTF å°é½Šï¼ˆæœ€å°å»¶é²ï¼Œcausalï¼‰
    module_a_enabled: true         # Module A: è¶¨å‹¢è·Ÿéš¨
    module_b_enabled: false        # Module B: MR åœ¨ crypto ä¸Šæ•ˆæœå·®
    entry_mode: "pullback_nw"      # NW ä¸­å¿ƒå›è¸© â€” æœ€ä½³ risk-adjusted

    # â•â•â• Phase B: Entry Quality Filters â•â•â•
    use_ltf_proxy: true            # 1h EMA cross ç¢ºèª â†’ é™ä½ regime å»¶é²
    ltf_ema_fast: 20               # 1h EMA fast period
    ltf_ema_slow: 50               # 1h EMA slow period
    use_momentum_confirm: true     # å‹•é‡æ¢å¾©ç¢ºèª â†’ é¿å… catching falling knives
    momentum_lookback: 3           # 3h å‹•é‡å›çœ‹
    min_pullback_depth: 0.3        # å›è¸©æ·±åº¦é–€æª»ï¼ˆ0-1, 0=ä¸éæ¿¾ï¼‰
    reentry_lockout: true          # å‡ºå ´å¾Œéœ€å›ç©¿ NW æ‰èƒ½åŒæ–¹å‘é‡å…¥

    # â•â•â• Nadaraya-Watson Kernel (1h) â•â•â•
    kernel_bandwidth: 8.0
    kernel_alpha: 1.0
    kernel_lookback: 200
    envelope_multiplier: 2.0
    envelope_window: 200

    # â•â•â• Regime Filter â•â•â•
    regime_mode: "adx"
    adx_period: 14
    adx_threshold: 20.0
    slope_window: 10
    slope_threshold: 0.001

    # â•â•â• 4h MTF Parameters â•â•â•
    htf_bandwidth: 8.0
    htf_lookback: 50
    htf_adx_period: 14
    htf_adx_threshold: 20.0
    htf_slope_window: 5
    htf_slope_threshold: 0.002

    # â•â•â• Position Scaling â•â•â•
    trend_scale: 1.0
    range_scale: 0.5
    mr_exit_target: "nw"

    # â•â•â• Risk / Exit â•â•â•
    atr_period: 14
    stop_loss_atr: 3.0             # å¯¬æ­¢æï¼šè®“è¶¨å‹¢å¥”è·‘
    take_profit_atr: 4.0           # æœ‰ç›®æ¨™æ­¢ç›ˆ
    trailing_stop_atr: null
    cooldown_bars: 8               # SL å¾Œå†·å»
    max_holding_bars: 0
    min_hold_bars: 4               # æœ€å°‘æŒå€‰

backtest:
  initial_cash: 10000
  fee_bps: 5
  slippage_bps: 3
  trade_on: "next_open"
  validate_data: true
  clean_data: true

  funding_rate:
    enabled: true
    default_rate_8h: 0.0001
    use_historical: true

  slippage_model:
    enabled: false

risk:
  max_drawdown_pct: 0.30

position_sizing:
  method: "volatility"
  position_pct: 1.0
  target_volatility: 0.25
  vol_lookback: 168

portfolio:
  cash_reserve: 0
  allocation:
    ETHUSDT: 0.40
    BTCUSDT: 0.30
    SOLUSDT: 0.30

live:
  kline_cache: true
  flip_confirmation: false
  prefer_limit_order: true
  limit_order_timeout_s: 10

notification:
  telegram_bot_token: ${FUTURES_TELEGRAM_BOT_TOKEN}
  telegram_chat_id: ${FUTURES_TELEGRAM_CHAT_ID}
  prefix: "ğŸŸ¡ [NW-Regime-V2]"
  enabled: true

output:
  report_dir: "./reports"
