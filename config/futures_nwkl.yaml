# åˆç´„ç­–ç•¥é…ç½®ï¼šNWKL v3.1ï¼ˆNadaraya-Watson + Lorentzian k-NN Classifierï¼‰
#
# v3.1 Dynamic Volatility Envelope â€” Long-Only + Panic Override
#
# æ ¸å¿ƒæ”¹å‹•ï¼š
#   1. å‹•æ…‹æ³¢å‹•ç‡åŒ…çµ¡ç·šï¼ˆv3.1 æ–°å¢ï¼‰ï¼š
#      - Z_vol = (ATR - Î¼(ATR, 168)) / Ïƒ(ATR, 168)
#      - ä½æ³¢å‹•ï¼ˆZ < -1ï¼‰â†’ 1.5Ã— MAEï¼ˆç‰›å¸‚æ·ºå›èª¿ï¼‰
#      - æ­£å¸¸             â†’ 2.0Ã— MAE
#      - é«˜æ³¢å‹•ï¼ˆZ > 2ï¼‰  â†’ 3.0Ã— MAEï¼ˆé¿å…æ¥åˆ€ï¼‰
#   2. LONG-ONLY å¼·åˆ¶ï¼šç§»é™¤æ‰€æœ‰ç©ºå€‰é‚è¼¯ï¼Œåªåšä½ä½è²·å…¥
#   3. Panic Overrideï¼š(ADX < 30) OR (RSI < 12) â†’ æ¥µç«¯è¶…è³£æ™‚è¦†è“‹ ADX é™åˆ¶
#   4. æ”¯æŒå¸‚åƒ¹å–® / Post-Only é™åƒ¹å–®
#   5. 2Ã— Leverageï¼šä½æ›å…‰ï¼ˆ~2.4%ï¼‰ä¸‹å®‰å…¨æ§“æ¡¿
#
# é æœŸè¡¨ç¾ï¼ˆ2022-2023 ETHUSDT 1Hï¼ŒMarket Ordersï¼‰ï¼š
#   Sharpe > 1.0ï¼ŒMDD < 20%
#
# å­¸è¡“åŸºç¤ï¼š
#   - Nadaraya (1964), Watson (1964): Kernel Regression
#   - Rational Quadratic Kernel: Rasmussen & Williams (2006)
#   - Lorentzian Distance: ln(1 + |x - y|)ï¼Œå°é›¢ç¾¤å€¼æ›´ç©©å¥
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   python scripts/download_data.py -c config/futures_nwkl.yaml
#   python scripts/research_nwkl.py --symbol ETHUSDT --start 2022-01-01 --end 2023-12-31
#   python scripts/run_backtest.py -c config/futures_nwkl.yaml
#   python scripts/run_live.py -c config/futures_nwkl.yaml --paper

market:
  symbols: ["ETHUSDT"]
  interval: "1h"
  start: "2022-01-01"
  end: null
  market_type: "futures"

futures:
  leverage: 2                    # â† v3.0: 2Ã— leverage
  margin_type: "ISOLATED"
  position_mode: "ONE_WAY"
  direction: "long_only"         # â† v3.0: Long-Only å¼·åˆ¶

strategy:
  name: "nwkl"
  params:
    # â”€â”€ Kernel Regression â”€â”€
    kernel_bandwidth: 3.0        # hï¼šå¹³æ»‘åº¦
    kernel_alpha: 1.0            # Î±ï¼šRQ kernel å°¾éƒ¨æ¬Šé‡
    kernel_lookback: 100         # å› æœå›çœ‹çª—å£
    envelope_multiplier: 2.0     # æ­£å¸¸æ³¢å‹•å€åŒ…çµ¡ç·šå€æ•¸
    envelope_window: 200         # MAE æ»¾å‹•çª—å£

    # â”€â”€ Dynamic Volatility Envelope (v3.1 æ–°å¢) â”€â”€
    dynamic_envelope: true       # å•Ÿç”¨å‹•æ…‹æ³¢å‹•ç‡åŒ…çµ¡ç·š
    vol_zscore_window: 168       # ATR Z-score çª—å£ï¼ˆ168 = 1 é€± hourlyï¼‰
    envelope_mult_low: 1.5      # ä½æ³¢å‹•å€æ•¸ï¼ˆZ < -1.0ï¼‰â†’ ç‰›å¸‚æ·ºå›èª¿
    envelope_mult_high: 3.0     # é«˜æ³¢å‹•å€æ•¸ï¼ˆZ > 2.0ï¼‰ â†’ é¿å…æ¥åˆ€
    vol_zscore_low: -1.0        # ä½æ³¢å‹• Z-score é–¾å€¼
    vol_zscore_high: 2.0        # é«˜æ³¢å‹• Z-score é–¾å€¼

    # â”€â”€ Lorentzian k-NN Classifier â”€â”€
    knn_k: 8                     # æœ€è¿‘é„°æ•¸é‡
    training_window: 2000        # è¨“ç·´çª—å£å¤§å°
    prediction_horizon: 4        # æ¨™ç±¤ç”Ÿæˆçš„æœªä¾† bars

    # â”€â”€ Feature Engineering â”€â”€
    rsi_period: 14
    cci_period: 20
    adx_period: 14
    feature_norm_window: 500     # ç‰¹å¾µ z-score æ¨™æº–åŒ–çª—å£

    # â”€â”€ Regime Filter + Panic Override â”€â”€
    adx_filter_enabled: true     # å•Ÿç”¨ ADX éæ¿¾å™¨
    adx_filter_threshold: 30     # Normal: ADX < 30 æ‰å…è¨±å…¥å ´
    rsi_panic_threshold: 12      # Panic: RSI < 12 è¦†è“‹ ADX é™åˆ¶

    # â”€â”€ Execution â”€â”€
    use_limit_orders: false      # â† v3.1: Market Ordersï¼ˆfill rate æ›´é«˜ï¼‰
    limit_order_expiry: 3        # é™åƒ¹å–®åˆ°æœŸ barsï¼ˆuse_limit_orders=true æ™‚ä½¿ç”¨ï¼‰

    # â”€â”€ Risk Management â”€â”€
    use_atr_stop: true           # ä½¿ç”¨ ATR å‹•æ…‹æ­¢æ
    atr_stop_multiplier: 1.5     # ATR æ­¢æå€æ•¸
    atr_period: 14
    stop_loss_pct: 0.02          # å›ºå®šæ­¢æï¼ˆuse_atr_stop=false æ™‚ä½¿ç”¨ï¼‰

    # â”€â”€ Take Profit â”€â”€
    tp_mode: "band"              # "band"/"mean"/"atr"
    tp_atr_multiplier: 1.5       # ATR æ­¢ç›ˆå€æ•¸ï¼ˆtp_mode="atr" æ™‚ä½¿ç”¨ï¼‰

backtest:
  initial_cash: 10000
  fee_bps: 5                     # â† v3.1: 0.05% taker fee (market orders)
  slippage_bps: 3                # â† v3.1: 0.03% slippage
  trade_on: "next_open"
  validate_data: true
  clean_data: true

  funding_rate:
    enabled: true
    default_rate_8h: 0.0001
    use_historical: true

  slippage_model:
    enabled: false               # Post-Only ä¸éœ€è¦æ»‘é»æ¨¡å‹

risk:
  max_drawdown_pct: 0.30

position_sizing:
  method: "fixed"
  position_pct: 1.0

portfolio:
  cash_reserve: 0
  allocation:
    ETHUSDT: 1.00

live:
  kline_cache: true
  flip_confirmation: false
  prefer_limit_order: true       # Post-Only
  limit_order_timeout_s: 10

notification:
  telegram_bot_token: ${FUTURES_TELEGRAM_BOT_TOKEN}
  telegram_chat_id: ${FUTURES_TELEGRAM_CHAT_ID}
  prefix: "ğŸŸ£ [NWKL v3.1]"
  enabled: true

output:
  report_dir: "./reports"
