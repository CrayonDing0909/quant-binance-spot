# ════════════════════════════════════════════════════════════════
# Risk Guard 風控規則 — Alt Ensemble (ETH+SOL TSMOM)
#
# 驗收背景：
#   Conditional Go (2026-02-19 audit)
#   策略: ETHUSDT tsmom_multi_ema 54% + SOLUSDT tsmom_ema 46%
#   Holdout: SR 1.12, MDD 7.6%, 12-month +13.3%
#   成本敏感度: -0.764 SR / 1x cost
#
# 使用方式：
#   python scripts/risk_guard.py --config config/risk_guard_alt_ensemble.yaml --dry-run
#   python scripts/risk_guard.py --config config/risk_guard_alt_ensemble.yaml --replay
# ════════════════════════════════════════════════════════════════

# 組合定義
portfolio:
  symbols: ["ETHUSDT", "SOLUSDT"]
  weights:
    ETHUSDT: 0.54
    SOLUSDT: 0.46
  strategies:
    ETHUSDT: "tsmom_multi_ema"
    SOLUSDT: "tsmom_ema"

# 回測假設基準（用於比較實際 vs 預期）
backtest_assumptions:
  fee_bps: 5
  slippage_bps: 3
  funding_rate_8h: 0.0001

# ════════════════════════════════════════════════════════════════
# Kill Switch Rules（按嚴重度排序）
# ════════════════════════════════════════════════════════════════
rules:
  # ── FLATTEN_ALL 等級（最嚴重）──
  - name: "rolling_sharpe_critical"
    description: "20D rolling Sharpe < -0.5 → 立即全平"
    metric: "rolling_sharpe_20d"
    condition: "lt"
    threshold: -0.5
    lookback_days: 1          # 連續 N 天觸發才生效
    action: "FLATTEN_ALL"
    severity: "CRITICAL"

  - name: "portfolio_mdd_breach"
    description: "組合 running MDD > 12% → 全平（= 回測 P95 MDD × 1.3）"
    metric: "running_mdd_pct"
    condition: "gt"
    threshold: 12.0
    lookback_days: 1
    action: "FLATTEN_ALL"
    severity: "CRITICAL"

  - name: "30d_return_catastrophic"
    description: "30D 滾動報酬 < -10% → 停止策略，觸發完整審計"
    metric: "return_30d_pct"
    condition: "lt"
    threshold: -10.0
    lookback_days: 1
    action: "FLATTEN_ALL"
    severity: "CRITICAL"

  # ── REDUCE_RISK_50 等級 ──
  - name: "slippage_drift"
    description: "實際滑點 > 回測假設 × 1.5 連續 5 天 → 降倉 50%"
    metric: "realized_slippage_bps"
    condition: "gt"
    threshold: 4.5             # 3bps × 1.5 = 4.5bps
    lookback_days: 5
    action: "REDUCE_RISK_50"
    severity: "HIGH"

  # ── DISABLE_SLEEVE 等級 ──
  - name: "sleeve_mdd_ethusdt"
    description: "ETHUSDT sleeve MDD > 15% → 關閉該 sleeve"
    metric: "sleeve_mdd_pct"
    symbol: "ETHUSDT"
    condition: "gt"
    threshold: 15.0
    lookback_days: 1
    action: "DISABLE_SLEEVE:ETHUSDT"
    severity: "HIGH"

  - name: "sleeve_mdd_solusdt"
    description: "SOLUSDT sleeve MDD > 15% → 關閉該 sleeve"
    metric: "sleeve_mdd_pct"
    symbol: "SOLUSDT"
    condition: "gt"
    threshold: 15.0
    lookback_days: 1
    action: "DISABLE_SLEEVE:SOLUSDT"
    severity: "HIGH"

  # ── WARNING 等級 ──
  - name: "rolling_sharpe_warning"
    description: "20D rolling Sharpe < 0 連續 3 天 → 人工審核"
    metric: "rolling_sharpe_20d"
    condition: "lt"
    threshold: 0.0
    lookback_days: 3
    action: "WARNING"
    severity: "MEDIUM"

  - name: "funding_drag_warning"
    description: "年化 funding 成本 > 2% → 評估是否關閉虧損 sleeve"
    metric: "funding_drag_annualized_pct"
    condition: "gt"
    threshold: 2.0
    lookback_days: 1
    action: "WARNING"
    severity: "MEDIUM"

  - name: "cost_drift_warning"
    description: "實際總成本 (fee+slip+funding) > 回測 × 1.3 → 人工審核"
    metric: "total_cost_ratio"
    condition: "gt"
    threshold: 1.3
    lookback_days: 3
    action: "WARNING"
    severity: "MEDIUM"

# ════════════════════════════════════════════════════════════════
# 30 天 Paper Gate
# ════════════════════════════════════════════════════════════════
paper_gate:
  duration_days: 30
  pass_criteria:
    min_sharpe_30d: -0.3       # 允許短期波動
    max_mdd_pct: 12.0
    max_slippage_ratio: 1.3    # 實際 / 回測
    max_funding_ratio: 1.5
    min_signal_consistency_pct: 98.0  # paper signal vs backtest replay
  fail_action: "回到研究迭代 — 重新評估策略參數或 sleeve 構成"

# ════════════════════════════════════════════════════════════════
# Replay 參數
# ════════════════════════════════════════════════════════════════
replay:
  stress_period_start: "2022-07-01"
  stress_period_end: "2023-01-01"
  strategy_config: "config/futures_ensemble_nw_tsmom.yaml"
  bar_interval: "1h"

# ════════════════════════════════════════════════════════════════
# 報告輸出
# ════════════════════════════════════════════════════════════════
output:
  report_dir: "reports/risk_guard"
  json_decision: true
  human_readable: true
  telegram_alert: false        # 上線後改 true
