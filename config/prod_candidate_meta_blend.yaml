# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PRODUCTION CANDIDATE â€” Meta-Blend 8-Symbol (R3C Ã— tsmom_carry_v2)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Created: 2026-02-25
# Origin: config/research_meta_blend.yaml (validated research config)
# Lineage: tsmom_carry_v2 (R4 research) â†’ meta_blend (R3C BTC integration)
#
# STRATEGY SUMMARY:
#   meta_blend æ··åˆå¤šå€‹å­ç­–ç•¥ä¿¡è™Ÿï¼Œper-symbol è·¯ç”±ï¼š
#     BTC:   breakout_vol_atr(30%) + tsmom_carry_v2 btc_enhanced(70%)
#     ETH:   100% tsmom_carry_v2 eth_enhanced (OI/FR/Basis)
#     SOL/AVAX: 100% tsmom_carry_v2 tsmom_heavy (70/30)
#     BNB/DOGE/ADA: 100% tsmom_carry_v2 default (50/50)
#     LINK:  100% tsmom_carry_v2 tsmom_only (carry IC unstable)
#
#   Removed symbols:
#     LTCUSDT â€” persistent negative OOS IC, no alpha
#     XRPUSDT â€” Sharpe 0.046, WFA OOS+ 40%, fails 2x cost
#
# VALIDATION RESULTS (2026-02-25, FR-path-corrected re-run):
#   Portfolio Sharpe:  2.265 (with vol_pause overlay; naked: 1.214)
#   Total Return:      +118.0%
#   Max Drawdown:      -4.2%
#   Calmar:            4.98
#   2x Cost Sharpe:    +1.648 (portfolio, with overlay) â†’ PASS
#   1.5x Cost Sharpe:  +1.957 (portfolio, with overlay) â†’ PASS
#   WFA OOS Positive:  88% (avg OOS Sharpe +0.85)
#   BTC Blend SR:      1.847 (with overlay; naked: 1.145)
#   Overlay Ablation:  +1.051 Sharpe delta â†’ vol_pause REQUIRED (2026-02-25)
#   FR path fix:       data_dir double-binance bug fixed, 7/8 symbols FR now loaded
#   Cost stress re-run: 2026-02-25, corrected FR path
#     (reports/research/overlay_4way/cost_stress_2x/cost_stress_20260225_155646.json)
#
# LINK TIER CHANGE (2026-02-25):
#   FR fix å¾Œ default tier SR 1.126ï¼Œå›žæ¸¬æ¯”è¼ƒ tsmom_only SR 1.300 (+15.4%)
#   tsmom_only åœ¨ 4/5 å¹´ä»½æ›´å¥½ä¸” 2x cost è€å—åŠ›æ›´å¼· (0.912 vs 0.745)
#   å·²åˆ‡æ›ç‚º tsmom_only tierï¼Œç§»é™¤æœ‰å®³çš„ carry confirmation
#
# KEY DIFFERENCES vs prod_live_R3C_E3.yaml:
#   - 8 symbols (was 10) â€” removed LTC (quarantined) and XRP (no alpha)
#   - Allocation sum = 3.0 (was 1.0) â€” 3Ã— allocation leverage, scaled MDD ~14%
#   - meta_blend handles per-symbol routing (no ensemble block needed)
#   - tsmom_carry_v2 adds carry confirmation to reduce MDD
#   - breakout_vol_atr retained for BTC (30% blend weight)
#   - vol_pause overlay ENABLED (same as R3C) â€” ablation proves complementary
#
# RISK AUDIT (2026-02-25):
#   Monte Carlo Bootstrap:   5th pct Return > 0 â†’ PASS
#   Trade-Order Shuffle:     MDD within bounds â†’ PASS
#   Cost Perturbation:       Sharpe > 0 at 2x costs â†’ PASS
#   Kelly Fraction:          Recommended 0.25 Kelly
#   Portfolio VaR (95%):     Within 40% MDD limit
#   Concentration (HHI):     0.128 (well-diversified)
#   Verdict: APPROVED (CONDITIONAL â€” paper trade 1-2 weeks first)
#
# DEPLOYMENT:
#   1. Paper trade: run_live.py -c config/prod_candidate_meta_blend.yaml --paper
#   2. Monitor 1-2 weeks for signal consistency
#   3. If MDD < 10% and signals match backtest â†’ promote to prod_live
#   4. If live MDD exceeds 10%, pause and review
#
# ROLLBACK:
#   Stop this config â†’ restart with prod_live_R3C_E3.yaml (existing prod)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

market:
  symbols:
    - BTCUSDT
    - ETHUSDT
    - SOLUSDT
    - BNBUSDT
    - DOGEUSDT
    - ADAUSDT
    - AVAXUSDT
    - LINKUSDT
  interval: "1h"
  start: "2022-01-01"
  end: null
  market_type: "futures"

futures:
  leverage: 3
  margin_type: "ISOLATED"
  position_mode: "ONE_WAY"
  direction: "both"

strategy:
  name: "meta_blend"
  params:
    # â”€â”€ Default sub-strategy combo (BNB, DOGE, ADA) â”€â”€
    # 100% tsmom_carry_v2 â€” carry confirmation reduces MDD
    sub_strategies:
      - name: "tsmom_carry_v2"
        weight: 1.0
        params:
          combination_mode: "confirmatory"
          tier: "default"
          tsmom_lookback: 168
          tsmom_vol_target: 0.15
          tsmom_ema_fast: 20
          tsmom_ema_slow: 50
          tsmom_agree_weight: 1.0
          tsmom_disagree_weight: 0.3
          basis_ema_fast: 24
          basis_ema_slow: 168
          basis_tanh_scale: 50.0
          fr_rolling_window: 72
          oi_z_window: 168
          basis_carry_fr_weight: 0.7
          basis_carry_basis_weight: 0.3
          w_tsmom: 0.50
          w_basis_carry: 0.50
          carry_agree_scale: 1.0
          carry_disagree_scale: 0.7
          carry_neutral_scale: 0.85
          carry_confirm_smoothing: 24
          composite_ema: 12
          position_step: 0.1
          min_change_threshold: 0.05

  symbol_overrides:
    # â”€â”€ BTC: breakout_vol_atr(30%) + tsmom_carry_v2(70%) â”€â”€
    # breakout_vol_atr Sharpe 1.18 vs V2 0.89 on BTC; corr = 0.60
    BTCUSDT:
      sub_strategies:
        - name: "breakout_vol_atr"
          weight: 0.30
          params:
            channel_period: 336
            channel_multiplier: 2.5
            atr_period: 14
            vol_fast_period: 14
            vol_slow_period: 72
            expansion_ratio: 1.1
            fake_breakout_bars: 6
            min_hold_bars: 24
            trail_exit_mid: true
            stop_loss_atr: 3.5
            max_holding_bars: 72
            cooldown_bars: 24
            vol_scale_enabled: true
            vol_scale_target: 99.0
            vol_scale_lookback: 168
            vol_scale_floor: 0.7
            vol_scale_cap: 0.7
            volume_confirm_enabled: true
            volume_confirm_period: 20
            volume_confirm_ratio: 1.5
        - name: "tsmom_carry_v2"
          weight: 0.70
          params:
            combination_mode: "confirmatory"
            tier: "btc_enhanced"
            tsmom_lookback: 720
            tsmom_ema_fast: 30
            tsmom_ema_slow: 100
            tsmom_vol_target: 0.15
            tsmom_agree_weight: 1.0
            tsmom_disagree_weight: 0.3
            basis_ema_fast: 24
            basis_ema_slow: 168
            basis_tanh_scale: 50.0
            carry_agree_scale: 1.0
            carry_disagree_scale: 0.6
            carry_neutral_scale: 0.85
            carry_confirm_smoothing: 24
            composite_ema: 12
            position_step: 0.1
            min_change_threshold: 0.05

    # â”€â”€ ETH: 100% tsmom_carry_v2 (eth_enhanced with OI/FR/Basis) â”€â”€
    ETHUSDT:
      sub_strategies:
        - name: "tsmom_carry_v2"
          weight: 1.0
          params:
            combination_mode: "confirmatory"
            tier: "eth_enhanced"
            tsmom_lookback: 168
            tsmom_vol_target: 0.15
            tsmom_ema_fast: 20
            tsmom_ema_slow: 50
            tsmom_agree_weight: 1.0
            tsmom_disagree_weight: 0.3
            w_tsmom: 0.40
            w_oi: 0.25
            w_fr: 0.15
            w_basis: 0.20
            basis_ema_fast: 24
            basis_ema_slow: 168
            basis_tanh_scale: 50.0
            fr_rolling_window: 72
            oi_z_window: 168
            carry_agree_scale: 1.0
            carry_disagree_scale: 0.7
            carry_neutral_scale: 0.85
            carry_confirm_smoothing: 24
            composite_ema: 12
            position_step: 0.1
            min_change_threshold: 0.05

    # â”€â”€ SOL: 100% tsmom_carry_v2 (tsmom_heavy: TSMOM 70% + BasisCarry 30%) â”€â”€
    SOLUSDT:
      sub_strategies:
        - name: "tsmom_carry_v2"
          weight: 1.0
          params:
            combination_mode: "confirmatory"
            tier: "tsmom_heavy"
            tsmom_lookback: 168
            tsmom_vol_target: 0.15
            tsmom_ema_fast: 20
            tsmom_ema_slow: 50
            tsmom_agree_weight: 1.0
            tsmom_disagree_weight: 0.3
            w_tsmom: 0.70
            w_basis_carry: 0.30
            basis_ema_fast: 24
            basis_ema_slow: 168
            basis_tanh_scale: 50.0
            fr_rolling_window: 72
            basis_carry_fr_weight: 0.7
            basis_carry_basis_weight: 0.3
            carry_agree_scale: 1.0
            carry_disagree_scale: 0.7
            carry_neutral_scale: 0.85
            carry_confirm_smoothing: 24
            composite_ema: 12
            position_step: 0.1
            min_change_threshold: 0.05

    # â”€â”€ AVAX: 100% tsmom_carry_v2 (tsmom_heavy: TSMOM 70% + BasisCarry 30%) â”€â”€
    AVAXUSDT:
      sub_strategies:
        - name: "tsmom_carry_v2"
          weight: 1.0
          params:
            combination_mode: "confirmatory"
            tier: "tsmom_heavy"
            tsmom_lookback: 168
            tsmom_vol_target: 0.15
            tsmom_ema_fast: 20
            tsmom_ema_slow: 50
            tsmom_agree_weight: 1.0
            tsmom_disagree_weight: 0.3
            w_tsmom: 0.70
            w_basis_carry: 0.30
            basis_ema_fast: 24
            basis_ema_slow: 168
            basis_tanh_scale: 50.0
            fr_rolling_window: 72
            basis_carry_fr_weight: 0.7
            basis_carry_basis_weight: 0.3
            carry_agree_scale: 1.0
            carry_disagree_scale: 0.7
            carry_neutral_scale: 0.85
            carry_confirm_smoothing: 24
            composite_ema: 12
            position_step: 0.1
            min_change_threshold: 0.05

    # â”€â”€ LINK: 100% tsmom_carry_v2 (tsmom_only â€” carry IC unstable) â”€â”€
    # Backtest: tsmom_only SR 1.300 vs default SR 1.126 (+15.4%)
    #           tsmom_only 2x cost SR 0.912 vs default 0.745 (+22.4%)
    #           tsmom_only better in 4/5 yearly periods
    # Rationale: LINK FR signal weak; carry confirmation reduces position
    #            when TSMOM is correct, net-harmful. Pure TSMOM is superior.
    # Evidence: reports/research/link_tier_compare/link_tier_compare_20260225_161947.json
    LINKUSDT:
      sub_strategies:
        - name: "tsmom_carry_v2"
          weight: 1.0
          params:
            tier: "tsmom_only"
            tsmom_lookback: 168
            tsmom_vol_target: 0.15
            tsmom_ema_fast: 20
            tsmom_ema_slow: 50
            tsmom_agree_weight: 1.0
            tsmom_disagree_weight: 0.3
            composite_ema: 12
            position_step: 0.1
            min_change_threshold: 0.05

  # â”€â”€ Overlay: vol_pause enabled (ABLATION-BACKED DECISION 2026-02-25) â”€â”€
  # 4-Way ablation test result:
#   Meta-Blend naked:       Sharpe 1.214, MDD -4.8%
#   Meta-Blend + vol_pause: Sharpe 2.265, MDD -4.2%
#   Overlay Sharpe delta: +1.051
  # Conclusion: carry confirmation does NOT replace vol_pause.
  #   vol_pause provides acute black-swan protection (vol z > 2.0 â†’ reduce position)
  #   carry confirmation provides chronic risk management (slow divergence â†’ scale down)
  #   These are complementary, not substitutes.
  # See: reports/research/overlay_4way/ for full ablation data.
  overlay:
    enabled: true
    mode: "oi_vol"
    params:
      oi_extreme_z: 999.0         # OI part effectively disabled
      oi_reversal_window: 6
      reduce_pct: 0.5
      oi_lookback: 24
      oi_z_window: 168
      vol_spike_z: 2.0            # Vol spike protection ENABLED
      overlay_cooldown_bars: 12
      trend_lookback: 20
      atr_period: 14
      vol_z_window: 168

backtest:
  initial_cash: 10000
  fee_bps: 5
  slippage_bps: 3
  trade_on: "next_open"
  validate_data: true
  clean_data: true
  funding_rate:
    enabled: true
    default_rate_8h: 0.0001
    use_historical: true
  slippage_model:
    enabled: false

risk:
  max_drawdown_pct: 0.40

position_sizing:
  method: "fixed"
  position_pct: 1.0

# â”€â”€ Portfolio allocation: 8-symbol, 3Ã— allocation leverage â”€â”€
# BTC/ETH overweight (45%) â€” strongest carry alpha + BTC breakout
# Others equal-weight (35%)
# Sum = 3.0 (3Ã— allocation leverage on top of 3Ã— futures leverage)
# Risk budget: backtest MDD -4.2% â†’ scaled MDD ~-13.9%, circuit breaker 40% â†’ 2.9Ã— buffer
# Extreme margin (all signals=1.0): 100% â€” practical peak ~50%
portfolio:
  cash_reserve: 0
  allocation:
    BTCUSDT: 0.45
    ETHUSDT: 0.45
    SOLUSDT: 0.35
    BNBUSDT: 0.35
    DOGEUSDT: 0.35
    ADAUSDT: 0.35
    AVAXUSDT: 0.35
    LINKUSDT: 0.35

live:
  kline_cache: true
  flip_confirmation: false
  prefer_limit_order: true
  limit_order_timeout_s: 10

  # â”€â”€ Rebalance Band: 3% threshold â”€â”€
  # Skip rebalance when |target - current| < 3% and same direction
  rebalance_band:
    enabled: true
    threshold_pct: 0.03
    apply_on_same_direction_only: true

  # â”€â”€ Symbol Governance: automated edge monitoring â”€â”€
  symbol_governance:
    enabled: true
    review_frequency: "weekly"
    warmup_days: 14
    quarantine_min_days: 14
    consecutive_reviews_for_quarantine: 2
    consecutive_reviews_for_recovery: 2
    artifacts_dir: "reports/symbol_governance"

    thresholds:
      edge_sharpe_deweight: 0.3
      edge_sharpe_quarantine: 0.0
      edge_sharpe_recover_active: 0.8
      edge_sharpe_recover_from_quarantine: 0.5
      edge_per_turnover_min: 0.0
      slippage_ratio_deweight: 1.5
      slippage_ratio_quarantine: 1.8
      slippage_ratio_recover_active: 1.2
      slippage_ratio_recover_from_quarantine: 1.3
      consistency_min: 99.0
      consistency_recover: 99.5
      missed_signals_quarantine: 5.0
      dd_quarantine_pct: 25.0

    weights:
      active_multiplier: 1.0
      deweight_multiplier: 0.5
      quarantine_multiplier: 0.0
      min_weight: 0.03
      max_weight: 0.20

  watchdog:
    enabled: true
    interval_sec: 300
    alert_cooldown_sec: 1800
    startup_grace_sec: 300
    runner_ready_grace_sec: 180
    heartbeat_warn_sec: 90
    heartbeat_critical_sec: 180
    ws_msg_warn_sec: 180
    ws_msg_critical_sec: 300
    data_warn_age_sec:
      "1h": 7200
      "5m": 1800
    data_critical_age_sec:
      "1h": 14400
      "5m": 3600
    error_window_minutes: 15
    error_warn_count: 5
    error_critical_count: 12

notification:
  telegram_bot_token: ${FUTURES_TELEGRAM_BOT_TOKEN}
  telegram_chat_id: ${FUTURES_TELEGRAM_CHAT_ID}
  prefix: "ðŸ”¬ [CANDIDATE-MetaBlend-8S]"
  enabled: true

output:
  report_dir: "./reports"
